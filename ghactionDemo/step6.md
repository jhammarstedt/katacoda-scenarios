# Committing and Pushing Changes to GitHub Repository

The format of the output file is json and it will be stored in the workflow, in order to later display it on our github page we need to actually push it from the workflow to our github repository. This can be done by first commiting the files in the workflow and then using another github action to push them.

## Commit
Begin by commiting the output file:
```
                        - name: Commit files
                          run: |
                               git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
                               git config --local user.name "github-actions[bot]"
                               git add .
                               git commit -m "Add new data" -a

```{{copy}}

This code adds all the changed files from the benchmarking script and commits them using the message "Add new data". We configure our GitHub so that a bot makes the commit using the commands.  
git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
git config --local user.name "github-actions[bot]".

## Push
We need to push the committed changes to the remote repository. We do that by inserting the following code directly after the code we used for committing:

```
                        - name: Push changes
                          uses: ad-m/github-push-action@master
                          with:
                                github_token: ${{ secrets.GITHUB_TOKEN }}
                                branch: ${{ github.ref }} 
```{{copy}}

`uses: ad-m/github-push-action@master` This is another GitHub action for pushing local changes to a GitHub repository using GitHub token.

`github_token: ${{ secrets.GITHUB_TOKEN }}` This is the GitHub token needed to authenticate the push.

`branch: ${{ github.ref }}` This specifies the destination branch that we are pushing our changes to, which will be the current branch we're on.


Our '.github/workflows/python.yml' file should now look like this:

```
name: Python benchmarking using pytest
on: push
jobs:
        benchmark:
                name: pytest-benchmarking
                runs-on: ubuntu-latest
                steps:
                        - uses: actions/checkout@v2
                          with:
                                persist-credentials: false
                                fetch-depth: 0 
                        - uses: actions/setup-python@v1
                        - name: Installing and running pytest
                          run: |
                                pwd
                                python -m pip install --upgrade pip
                                if [ -f requirements.txt ]; 
                                then pip install -r requirements.txt; fi
                                python test.py
                                pytest benchmarking.py --benchmark-json output.json
                        - name: Commit files
                          run: |
                               git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
                               git config --local user.name "github-actions[bot]"
                               git add .
                               git commit -m "Add new data" -a
                        - name: Push changes
                          uses: ad-m/github-push-action@master
                          with:
                                github_token: ${{ secrets.GITHUB_TOKEN }}
                                branch: ${{ github.ref }} 
```{{copy}}


`touch src/generate_output.py`{{execute}}

We then need to insert the following code into the 'src/generate_output.py' script:


```import json
from bs4 import BeautifulSoup
import os

"""
This file will read the latest output file generated by the workflow and take out relevant statistics.
As this tutorial is more to show of the workflow and how to set up a github action than building websites,
we'll be simply inserting the new data in the index.html file instead of having a js file that would read the json file.
which requires some more integration.
"""

with open("output.json","r") as f: 
    data = json.load(f)

# First we get the new data statistics as a markdown to the index file
commit = data["commit_info"]["id"]
date = data["commit_info"]["time"]
mean = data["benchmarks"][0]["stats"]["mean"]
mini = data["benchmarks"][0]["stats"]["mean"]
maxi = data["benchmarks"][0]["stats"]["max"]
std = data["benchmarks"][0]["stats"]["stddev"]

# The format of the index.html is to place new entires in <tr> = <tablerow> which will be inside a tableBody
new_data = f"""<tr>
                <td>{commit} </td>
                <td>{date}</td>
                <td>{mean}</td>
                <td>{maxi}</td>
                <td>{mini}</td>
                <td>{std}</td>
            </tr>"""

# Using bs4 we can now just insert the new data to the table, maybe not best practice but it works :)
html = open('docs/index.html')
soup = BeautifulSoup(html,'html.parser')
soup.tbody.tr.append(BeautifulSoup( new_data,'html.parser'))
html.close()

new_html = soup.prettify(soup.original_encoding)
with open("docs/index.html",'w') as f:
      f.write(new_html)
      f.close()
```{{copy}}



The 'data/generate_output.py' script formats the json file we get when running pytest. It presents the results in an html file using tables. 

We have to add the benchmarking and formatting scripts to our GitHub action. Open the '.github/workflows/python.yml' file using a text editor and insert the following code below the last line:

```
python data/generate_output.py
```{{copy}}

This code will run the pytest benchmarking tool on the 'benchmarking.py' script and the results will be stored in the 'output.json' file. The 'data/generate_output.py' will then format the results stored in 'output.json' and store it in the 'index.html' file. 
