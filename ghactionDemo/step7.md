# Handling the data and display it with Github Pages
<!--
Nice seeing the continuation of the image series and a clear and concise explanation about GitHub pages. Since you say that the tutorial does not cover bs4, which is completely reasonable, but it feels weird to copy or manually write that code if it is not explained. Maybe you can include that file automatically and only tell the user that it exists.

** Fixed: Added the generate_output.json file automatically so user won't have to fix it **
-->

Now we have an output.json file ready to be displayed. But there are still a couple of issues here. The output file will be overwritten every time and we don't have a way to display the history and compare the results. One could solve this in multiple ways by simply saving data from the output file in another file as mentioned earlier, but we will utilize GitHub pages to display some selected statistics in a table. 

## Setting up GitHub Pages
Go to settings on Github and press Pages. Under source select master and then press save
Just like that, you have a page!
<img src="https://github.com/jhammarstedt/katacoda-scenarios/blob/main/ghactionDemo/images/pages_intro1.PNG?raw=true" />

Your page should now be published on `https://INSERT_USERNAME.github.io/Benchmark_Tutorial/`

If nothing is specified the page will display your README.md file. In our case we want it to run the `index.html` file in `docs/`. 
* So change the source from root to docs as shown in the image. 

Github pages will either by default read an index.md or index.html, which fortunately for you, is already in there (both the index file and the CSS file were just taken from this [template website](https://uicookies.com/css-table-templates/)). 

You can press the link and try to run it. It might be a little slow to update so if it doesn't work wait for a little and refresh the page.

Examining the flowchart again:
<img src="https://github.com/jhammarstedt/katacoda-scenarios/blob/main/ghactionDemo/images/framework.PNG?raw=true" />

We haven't addressed the `generate_output` file yet. For simplicity, we will just write a python script that reads the `output.json` and edits the `index.html` by adding the new table values. For the `index.html` file we choose the include Commit, Date, Mean, Max, Min, Standard Deviation (All in ms). 

(The file could look odd but you can format it by right-clicking and press `Format Document` while watching the file in the IDE)

<img src="https://github.com/jhammarstedt/katacoda-scenarios/blob/main/ghactionDemo/images/index_prev.PNG?raw=true" />


This tutorial won't cover [BeautifulSoup](https://www.crummy.com/software/BeautifulSoup/bs4/doc/) so we have therefore provided you with the script already. But it's a good package to handle HTML files in so feel free to read their documentation.

<!-- 
Now let's create the python script.

`touch src/generate_output.py`{{execute}}

T

``` 
import json
from bs4 import BeautifulSoup
import os

"""
This file will read the latest output file generated by the workflow and take out relevant statistics.
As this tutorial is more to show off the workflow and how to set up a GitHub action than building websites,
we'll be simply inserting the new data in the index.html file instead of having a js file that would read the JSON file.
which requires some more integration.
"""

with open("output.json","r") as f: 
    data = json.load(f)

# First we get the new data statistics as a markdown to the index file
commit = data["commit_info"]["id"]
date = data["commit_info"]["time"]
mean = data["benchmarks"][0]["stats"]["mean"]
mini = data["benchmarks"][0]["stats"]["mean"]
maxi = data["benchmarks"][0]["stats"]["max"]
std = data["benchmarks"][0]["stats"]["stddev"]

# The format of the index.html is to place new entires in <tr> = <tablerow> which will be inside a tableBody
new_data = f"""<tr>
                <td>{commit} </td>
                <td>{date}</td>
                <td>{mean}</td>
                <td>{maxi}</td>
                <td>{mini}</td>
                <td>{std}</td>
            </tr>"""

# Using bs4 we can now just insert the new data to the table, maybe not best practice but it works :)
html = open('docs/index.html')
soup = BeautifulSoup(html,'html.parser')
soup.tbody.tr.append(BeautifulSoup( new_data,'html.parser'))
html.close()

new_html = soup.prettify(soup.original_encoding)
with open("docs/index.html",'w') as f:
      f.write(new_html)
      f.close()
```{{copy}}
-->

The 'src/generate_output.py' script reads the JSON with the new data and inserts the specified values into the index.html so it can be displayed on our page. It's not required to understand it as part of this tutorial but feel free to check it out anyway.

We have to add the benchmarking and formatting scripts to our GitHub action. Open the `.github/workflows/python.yml` file and insert the following code below the line containing `pytest src/benchmarking.py --benchmark-json output.json`:
<pre class="file" 
data-target = "clipboard">

python src/generate_output.py
</pre>

This code will run the pytest benchmarking tool on the 'benchmarking.py' script and the results will be stored in the 'output.json' file. The 'src/generate_output.py' will then format the results stored in 'output.json' and store them in the 'index.html' file. 

<details> 
<summary>The current python.yml file is available here</summary>
<pre class="file" 
data-target = "clipboard">

name: Python benchmarking using pytest
on: push
jobs:
        benchmark:
                name: pytest-benchmarking
                runs-on: ubuntu-latest
                steps:
                      - uses: actions/checkout@v2
                        with:
                                persist-credentials: false
                                fetch-depth: 0 
                      - uses: actions/setup-python@v1
                      - name: Installing and running pytest
                        run: |
                                pwd
                                python -m pip install --upgrade pip
                                if [ -f requirements.txt ]; 
                                then pip install -r requirements.txt; fi
                                python src/test.py
                                pytest src/benchmarking.py --benchmark-json output.json
                                python src/generate_output.py
                      - name: Commit files
                        run: |
                            git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
                            git config --local user.name "github-actions[bot]"
                            git add .
                            git commit -m "Add new data" -a
                      - name: Push changes
                        uses: ad-m/github-push-action@master
                        with:
                                github_token: ${{ secrets.GITHUB_TOKEN }}
                                branch: ${{ github.ref }}
</pre>
</details>